<!DOCTYPE html>
<html>

<head>
    <title>Administrador de PCs</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Styles for the attack alert banner */
        .attack-banner {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: #ef4444;
            color: white;
            text-align: center;
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            z-index: 1000;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.7; }
        }
    </style>
</head>

<body>

    <!-- Attack Alert Banner -->
    <div id="attack-banner" class="attack-banner">
        ¬°ATAQUE DETECTADO!
    </div>

    <!-- Sidebar / Top Navigation Bar -->
    <header class="topbar">
        <h2>RIWI<span>Manager</span></h2>
        <nav>
            <a href="/equipos/">Network</a>
            <a href="/reportes">Reportes</a>
            <a href="/logout">Cerrar sesi√≥n</a>
        </nav>
    </header>
    
    <main class="main"></main>

    <h1>Lista de Equipos</h1>
    <form action="/equipos/add" method="post">
        <input type="text" name="hostname" placeholder="Hostname" required>
        <input type="text" name="mac" placeholder="MAC" required>
        <input type="text" name="ip" placeholder="IP" required>
        <button type="submit" class="agre">Agregar</button>
    </form>

<section class="cards">
  {% for e in equipos %}
  <article class="card-pc">
    
      <h3 class="hostname">{{ e['hostname'] }}</h3><b></b>
      <img class="pc-icon" src="/static/imag/computadora (3).png" alt="PC" />
     
    <ul class="info">
      <li><strong>ID:</strong> {{ e['id'] }}</li>
      <li><strong>MAC:</strong> {{ e['mac'] }}</li>
      <li><strong>IP:</strong> {{ e['ip'] }}</li>
      <li><strong>Estado:</strong> {{ e['estado'] }}</li>
      <li>
        <strong>Conectado:</strong>
        {% if e['conectado'] %}<span class="pill ok">üü¢ S√≠</span>{% else %}<span class="pill bad">üî¥ No</span>{% endif %}
      </li>
      <li>
        <strong>Error:</strong>
        {% if e['error'] %}<span class="pill warn">‚ö†Ô∏è {{ e['error'] }}</span>{% else %}<span class="pill mute">Sin errores</span>{% endif %}
      </li>
    </ul>

    <div class="acciones">
      <a class="btn-accion btn-on" href="/actions/encender/{{ e['mac'] }}">Encender</a>
      <a class="btn-accion btn-off" href="/actions/apagar/{{ e['ip'] }}">Apagar</a>
      <a class="btn-accion btn-update" href="/actions/update/{{ e['ip'] }}">Actualizar</a>
      <a class="btn-accion" href="/actions/bienvenida/{{ e['ip'] }}">Bienvenida</a>
      <a class="btn-accion btn-delete" href="/equipos/delete/{{ e['id'] }}">Eliminar</a>
    </div>
  </article>
  {% endfor %}
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const banner = document.getElementById("attack-banner");
        const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;

        function connect() {
            const ws = new WebSocket(wsUrl);

            ws.onopen = () => console.log("Dashboard connected to WebSocket.");

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "attack") {
                    console.log("Attack signal received on dashboard!", data);
                    banner.textContent = `¬°ATAQUE DETECTADO DESDE IP: ${data.ip}!`;
                    banner.style.display = "block";

                    setTimeout(() => {
                        banner.style.display = "none";
                    }, 10000);
                }
            };

            ws.onclose = () => {
                console.log("Dashboard WebSocket disconnected. Reconnecting...");
                setTimeout(connect, 3000);
            };

            ws.onerror = (error) => {
                console.error("Dashboard WebSocket error:", error);
                ws.close();
            };
        }

        connect();
    });
</script>

</body>
</html>
